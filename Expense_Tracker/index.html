<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Expense Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .modal { display: none; }
        .modal.active { display: flex; }
        .input {
            width: 100%; padding: 0.5rem 0.75rem; background-color: white; 
            border: 1px solid #d1d5db; border-radius: 0.375rem; 
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            outline: none;
        }
        .input:focus {
             border-color: #4f46e5;
             box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.5);
        }
    </style>
</head>
<body class="text-gray-800">

    <div id="app-container" class="hidden">
        <header class="bg-white shadow-sm">
            <div class="container mx-auto p-4 max-w-7xl flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">Expense Dashboard</h1>
                    <p class="text-gray-600">Welcome, <span id="username-display" class="font-semibold"></span>!</p>
                </div>
                <div>
                    <button id="manage-categories-btn" class="bg-gray-200 text-gray-800 py-2 px-4 rounded-md hover:bg-gray-300 font-semibold mr-2">Manage Categories</button>
                    <a href="logout.php" class="bg-red-600 text-white py-2 px-4 rounded-md hover:bg-red-700 font-semibold">Logout</a>
                </div>
            </div>
        </header>

        <main class="container mx-auto p-4 md:p-8 max-w-7xl grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-1 space-y-8">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 id="form-title" class="text-2xl font-semibold mb-4">Add New Expense</h2>
                    <form id="expense-form" class="space-y-4">
                        <input type="hidden" id="expense-id" name="id">
                        <div>
                            <label for="description" class="block text-sm font-medium text-gray-700">Description</label>
                            <input type="text" id="description" placeholder="e.g., Dinner with family" required class="input">
                        </div>
                        <div>
                            <label for="amount" class="block text-sm font-medium text-gray-700">Amount (₹)</label>
                            <input type="number" id="amount" step="0.01" placeholder="e.g., 850.00" required class="input">
                        </div>
                        <div>
                            <label for="category" class="block text-sm font-medium text-gray-700">Category</label>
                            <select id="category" class="input"></select>
                        </div>
                         <div>
                            <label for="receipt_url" class="block text-sm font-medium text-gray-700">Receipt URL (Optional)</label>
                            <input type="url" id="receipt_url" placeholder="https://example.com/receipt.jpg" class="input">
                        </div>
                        <div>
                            <label for="date" class="block text-sm font-medium text-gray-700">Date</label>
                            <input type="date" id="date" required class="input">
                        </div>
                        <button type="submit" id="submit-btn" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 font-semibold">Add Expense</button>
                        <button type="button" id="cancel-edit-btn" class="w-full bg-gray-500 text-white py-2 px-4 rounded-md hover:bg-gray-600 font-semibold hidden">Cancel Edit</button>
                    </form>
                </div>

                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-semibold mb-4">Recent Expenses</h2>
                    <div id="expense-list" class="space-y-3 max-h-[400px] overflow-y-auto pr-2"></div>
                </div>
            </div>

            <div class="lg:col-span-2 space-y-8">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <div class="bg-white p-6 rounded-lg shadow-md text-center">
                        <h3 class="font-semibold text-gray-600 mb-2">Spending Forecast</h3>
                        <p id="prediction-amount" class="text-3xl font-bold text-indigo-600">₹0.00</p>
                        <p id="prediction-trend" class="text-gray-500 text-sm mt-1">Not enough data.</p>
                    </div>
                     <div class="bg-white p-6 rounded-lg shadow-md text-center">
                        <h3 class="font-semibold text-gray-600 mb-2">Top Category</h3>
                        <p id="top-category" class="text-3xl font-bold text-green-600">N/A</p>
                    </div>
                     <div class="bg-white p-6 rounded-lg shadow-md text-center">
                        <h3 class="font-semibold text-gray-600 mb-2">Largest Purchase</h3>
                        <p id="largest-purchase" class="text-xl font-bold text-red-600 truncate">N/A</p>
                         <p id="largest-purchase-amount" class="text-gray-500 text-sm"></p>
                    </div>
                </div>
                
                <div class="bg-white p-6 rounded-lg shadow-md">
                     <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-semibold">Monthly Breakdown</h2>
                        <button id="view-history-btn" class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 font-semibold">View History & Reports</button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
                        <div class="h-64 md:h-80"><canvas id="categoryPieChart"></canvas></div>
                        <div id="budget-progress-indicators" class="space-y-4"></div>
                    </div>
                </div>

                 <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-semibold mb-4">Set Monthly Budget</h2>
                    <form id="set-budget-form" class="flex items-end gap-4">
                        <div class="flex-grow">
                            <label for="budget-category" class="block text-sm font-medium text-gray-700">Category</label>
                            <select id="budget-category" class="input mt-1"></select>
                        </div>
                        <div class="flex-grow">
                             <label for="budget-amount" class="block text-sm font-medium text-gray-700">Amount</label>
                            <input type="number" step="0.01" id="budget-amount" placeholder="Budget Amount" class="input mt-1" required>
                        </div>
                        <button type="submit" class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 font-semibold h-10">Set</button>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="history-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col">
            <div class="p-4 border-b flex justify-between items-center">
                <h2 class="text-2xl font-semibold">Expense History & Reports</h2>
                <button class="close-modal-btn font-bold text-2xl hover:text-red-500">&times;</button>
            </div>
            <div class="p-4 flex-grow overflow-y-auto">
                <div class="h-96 mb-8"><canvas id="historyBarChart"></canvas></div>
                <h3 class="text-xl font-semibold mb-4">All Transactions</h3>
                <div id="history-table-container" class="overflow-auto border rounded-lg"></div>
            </div>
        </div>
    </div>
    <div id="category-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center p-4 z-50">
         <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
             <div class="p-4 border-b flex justify-between items-center">
                <h2 class="text-2xl font-semibold">Manage Categories</h2>
                <button class="close-modal-btn font-bold text-2xl hover:text-red-500">&times;</button>
            </div>
            <div class="p-4">
                <form id="add-category-form" class="flex gap-2 mb-4">
                    <input type="text" id="new-category-name" placeholder="New category name" class="w-full input" required>
                    <button type="submit" class="bg-green-600 text-white px-4 rounded-md hover:bg-green-700 font-semibold">Add</button>
                </form>
                <div id="category-list" class="space-y-2 max-h-64 overflow-y-auto"></div>
            </div>
         </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', async function() {
        // Check session status first
        const session = await fetch('check_session.php').then(res => res.json());
        if (!session.loggedIn) {
            window.location.href = 'login.html';
            return;
        }
        
        document.getElementById('app-container').classList.remove('hidden');
        document.getElementById('username-display').textContent = session.username;

        const API = {
            ADD_EXPENSE: 'add_expense.php',
            UPDATE_EXPENSE: 'update_expense.php',
            GET_EXPENSES: 'get_expenses.php',
            REMOVE_EXPENSE: 'remove_expense.php',
            GET_DASHBOARD: 'get_dashboard_data.php',
            SET_BUDGET: 'set_budget.php',
            MANAGE_CATEGORIES: 'manage_categories.php',
            GET_HISTORY: 'get_history.php',
        };

        const expenseForm = document.getElementById('expense-form');
        const expenseList = document.getElementById('expense-list');
        const categorySelects = [document.getElementById('category'), document.getElementById('budget-category')];
        let categoryPieChart, historyBarChart;

        async function fetchAllData() {
            await fetchCategories();
            await fetchDashboardData();
            await fetchExpenses();
        }

        async function fetchCategories() {
            const res = await fetch(API.MANAGE_CATEGORIES);
            const data = await res.json();
            if (data.success) {
                const defaultCategories = ['Uncategorized', 'Food', 'Transport', 'Shopping', 'Utilities', 'Entertainment', 'Health'];
                const userCategories = data.categories.map(c => c.name);
                const allCategories = [...new Set([...defaultCategories, ...userCategories])].sort();

                categorySelects.forEach(select => {
                    const currentVal = select.value;
                    select.innerHTML = '';
                    allCategories.forEach(cat => {
                        const option = document.createElement('option');
                        option.value = cat;
                        option.textContent = cat;
                        select.appendChild(option);
                    });
                    if (currentVal && allCategories.includes(currentVal)) select.value = currentVal;
                });
                renderCategoryManager(data.categories);
            }
        }

        async function fetchDashboardData() {
            const res = await fetch(`${API.GET_DASHBOARD}?month=${new Date().getMonth()+1}&year=${new Date().getFullYear()}`);
            const data = await res.json();
            if (data.success) {
                renderCategoryChart(data.categorySpending);
                renderBudgetStatus(data.budgetStatus);
                renderPrediction(data.spendingPrediction);
                renderInsights(data.insights);
            }
        }
        
        async function fetchExpenses() {
            const res = await fetch(API.GET_EXPENSES);
            const data = await res.json();
            if (data.success) renderExpenses(data.expenses);
        }

        function renderExpenses(expenses) {
             expenseList.innerHTML = '';
             if (expenses.length === 0) {
                 expenseList.innerHTML = '<p class="text-gray-500">No recent expenses.</p>';
                 return;
             }
             expenses.forEach(exp => {
                 const el = document.createElement('div');
                 el.className = 'flex justify-between items-center p-3 bg-gray-50 rounded-md';
                 el.innerHTML = `
                    <div>
                        <p class="font-semibold">${exp.description}</p>
                        <p class="text-sm text-gray-500">${exp.category} - ${exp.expense_date}</p>
                    </div>
                    <div class="flex items-center space-x-3">
                         <span class="font-bold text-lg text-red-600">-₹${parseFloat(exp.amount).toFixed(2)}</span>
                         <button data-expense='${JSON.stringify(exp)}' class="edit-expense-btn text-gray-400 hover:text-blue-500 text-lg" title="Edit">&#9998;</button>
                         <button data-id="${exp.id}" class="remove-expense-btn text-gray-400 hover:text-red-500 font-bold text-xl" title="Remove">&times;</button>
                    </div>`;
                 expenseList.appendChild(el);
             });
        }
        
        function renderPrediction({ amount, trend }) {
            document.getElementById('prediction-amount').textContent = `₹${parseFloat(amount).toFixed(2)}`;
            document.getElementById('prediction-trend').textContent = trend;
        }

        function renderInsights({ largest_purchase, top_category }) {
            document.getElementById('top-category').textContent = top_category ? top_category.category : 'N/A';
            if (largest_purchase) {
                 document.getElementById('largest-purchase').textContent = largest_purchase.description;
                 document.getElementById('largest-purchase-amount').textContent = `₹${parseFloat(largest_purchase.amount).toFixed(2)}`;
            } else {
                 document.getElementById('largest-purchase').textContent = 'N/A';
                 document.getElementById('largest-purchase-amount').textContent = '';
            }
        }
        
        function renderCategoryChart(data) {
            const ctx = document.getElementById('categoryPieChart').getContext('2d');
            const labels = data.length > 0 ? data.map(d => d.category) : ['No Data'];
            const values = data.length > 0 ? data.map(d => d.total) : [1];
            if (categoryPieChart) categoryPieChart.destroy();
            categoryPieChart = new Chart(ctx, { 
                type: 'doughnut', data: { labels, datasets: [{ data: values, backgroundColor: ['#4f46e5', '#ef4444', '#f59e0b', '#10b981', '#6366f1', '#ec4899', '#6b7280'] }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
            });
        }
        
        function renderBudgetStatus(budgets) {
            const container = document.getElementById('budget-progress-indicators');
            container.innerHTML = '';
            if (budgets.length === 0) {
                 container.innerHTML = '<p class="text-gray-500 text-center">No budgets set for this month.</p>';
                 return;
            }
            budgets.forEach(b => {
                const p = b.budget > 0 ? (b.spent / b.budget) * 100 : 0;
                const color = p > 100 ? 'bg-red-500' : p > 75 ? 'bg-yellow-500' : 'bg-green-500';
                const el = document.createElement('div');
                el.innerHTML = `
                    <div class="flex justify-between mb-1"><span class="font-medium">${b.category}</span><span>₹${parseFloat(b.spent).toFixed(2)} / ₹${parseFloat(b.budget).toFixed(2)}</span></div>
                    <div class="w-full bg-gray-200 rounded-full h-2.5"><div class="${color} h-2.5 rounded-full" style="width: ${Math.min(p, 100)}%"></div></div>`;
                container.appendChild(el);
            });
        }
        
        function renderCategoryManager(categories) {
            const listEl = document.getElementById('category-list');
            listEl.innerHTML = '';
            categories.forEach(cat => {
                const el = document.createElement('div');
                el.className = 'flex justify-between items-center bg-gray-100 p-2 rounded';
                el.innerHTML = `<span>${cat.name}</span><button data-id="${cat.id}" class="delete-category-btn text-red-500 font-bold">&times;</button>`;
                listEl.appendChild(el);
            });
        }

        expenseForm.addEventListener('submit', async e => {
            e.preventDefault();
            const id = document.getElementById('expense-id').value;
            const isEditing = !!id;
            const api = isEditing ? API.UPDATE_EXPENSE : API.ADD_EXPENSE;

            const data = {
                id: id, description: document.getElementById('description').value,
                amount: document.getElementById('amount').value, category: document.getElementById('category').value,
                date: document.getElementById('date').value, receipt_url: document.getElementById('receipt_url').value,
            };

            const res = await fetch(api, { method: 'POST', body: JSON.stringify(data) });
            const result = await res.json();
            alert(result.message);

            if (result.success) {
                document.getElementById('cancel-edit-btn').click();
                fetchAllData();
            }
        });
        
        expenseList.addEventListener('click', e => {
            const removeBtn = e.target.closest('.remove-expense-btn');
            if (removeBtn) {
                const id = removeBtn.dataset.id;
                if (confirm('Are you sure you want to delete this expense?')) {
                    fetch(API.REMOVE_EXPENSE, { method: 'POST', body: JSON.stringify({id}) })
                        .then(res => res.json()).then(result => {
                            alert(result.message);
                            if (result.success) fetchAllData();
                        });
                }
            }
            const editBtn = e.target.closest('.edit-expense-btn');
            if (editBtn) {
                const expense = JSON.parse(editBtn.dataset.expense);
                document.getElementById('form-title').textContent = 'Edit Expense';
                document.getElementById('expense-id').value = expense.id;
                document.getElementById('description').value = expense.description;
                document.getElementById('amount').value = expense.amount;
                document.getElementById('category').value = expense.category;
                document.getElementById('date').value = expense.expense_date;
                document.getElementById('receipt_url').value = expense.receipt_url;
                document.getElementById('submit-btn').textContent = 'Update Expense';
                document.getElementById('cancel-edit-btn').classList.remove('hidden');
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        });

        document.getElementById('cancel-edit-btn').addEventListener('click', () => {
             expenseForm.reset();
             document.getElementById('date').valueAsDate = new Date();
             document.getElementById('form-title').textContent = 'Add New Expense';
             document.getElementById('submit-btn').textContent = 'Add Expense';
             document.getElementById('cancel-edit-btn').classList.add('hidden');
        });
        
        document.getElementById('set-budget-form').addEventListener('submit', async e => {
            e.preventDefault();
            const data = {
                category: document.getElementById('budget-category').value, amount: document.getElementById('budget-amount').value,
                month: new Date().getMonth() + 1, year: new Date().getFullYear()
            };
            const res = await fetch(API.SET_BUDGET, { method: 'POST', body: JSON.stringify(data) });
            const result = await res.json();
            alert(result.message);
            if (result.success) {
                document.getElementById('budget-amount').value = '';
                fetchDashboardData();
            }
        });

        document.getElementById('manage-categories-btn').addEventListener('click', () => document.getElementById('category-modal').classList.add('active'));
        document.getElementById('view-history-btn').addEventListener('click', async () => {
            const res = await fetch(API.GET_HISTORY);
            const data = await res.json();
            if (data.success) {
                renderHistory(data);
                document.getElementById('history-modal').classList.add('active');
            }
        });
        document.querySelectorAll('.close-modal-btn').forEach(btn => btn.addEventListener('click', () => {
            btn.closest('.modal').classList.remove('active');
        }));
        
        document.getElementById('add-category-form').addEventListener('submit', async e => {
            e.preventDefault();
            const name = document.getElementById('new-category-name').value;
            const res = await fetch(API.MANAGE_CATEGORIES, { method: 'POST', body: JSON.stringify({name}) });
            const result = await res.json();
            if (result.success) {
                document.getElementById('new-category-name').value = '';
                fetchCategories();
            } else alert(result.message);
        });

        document.getElementById('category-list').addEventListener('click', e => {
            const deleteBtn = e.target.closest('.delete-category-btn');
            if (deleteBtn) {
                const id = deleteBtn.dataset.id;
                if(confirm('Are you sure you want to delete this category?')) {
                    fetch(`${API.MANAGE_CATEGORIES}?id=${id}`, { method: 'DELETE' })
                        .then(res => res.json()).then(result => {
                            if (result.success) fetchCategories(); else alert(result.message);
                        });
                }
            }
        });
        
        function renderHistory({ monthlyData, transactions }) {
            const ctx = document.getElementById('historyBarChart').getContext('2d');
            const labels = monthlyData.map(d => `${d.month} ${d.year}`);
            const values = monthlyData.map(d => d.total);
            if (historyBarChart) historyBarChart.destroy();
            historyBarChart = new Chart(ctx, { type: 'bar', data: { labels, datasets: [{ label: 'Total Spending', data: values, backgroundColor: '#4f46e5' }] } });
            
            const container = document.getElementById('history-table-container');
            const table = document.createElement('table');
            table.className = "min-w-full divide-y divide-gray-200";
            table.innerHTML = `
                <thead class="bg-gray-50"><tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                </tr></thead>
                <tbody class="bg-white divide-y divide-gray-200"></tbody>`;
            const tbody = table.querySelector('tbody');
            transactions.forEach(t => {
                const row = tbody.insertRow();
                row.innerHTML = `<td class="px-6 py-4 whitespace-nowrap text-sm">${t.expense_date}</td>
                                 <td class="px-6 py-4 whitespace-nowrap text-sm">${t.description}</td>
                                 <td class="px-6 py-4 whitespace-nowrap text-sm">${t.category}</td>
                                 <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold">₹${parseFloat(t.amount).toFixed(2)}</td>`;
            });
            container.innerHTML = '';
            container.appendChild(table);
        }

        fetchAllData();
    });
    </script>
</body>
</html>